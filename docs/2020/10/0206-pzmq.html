<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <title>pzmq
    </title>
    <link rel='alternate' href='https://40ants.com/lisp-project-of-the-day/rss.xml' type='application/rss+xml' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL71WXK73K"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FL71WXK73K');
      </script>
  
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
         (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
         m[i].l=1*new Date();
         for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
         k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
         (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

         ym(42462884, "init", {
              clickmap:true,
              trackLinks:true,
              accurateTrackBounce:true
         });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/42462884" style="position:absolute ; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->

    <link type='text/css' rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' />
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    <link rel='stylesheet' href='../../highlight/styles/tomorrow-night.css' />
    <script src='../../highlight/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad() ;
    </script>
    <style>

.tags .label {
    margin-right: 1em;
}
.posts tr {
    line-height: 1.7em;
}
.posts tr td.number {
    font-weight: bold;
    padding-right: 0.7em;
}
.posts tr td.tags {
    padding-left: 0.7em;
}
h1 .tags {
    font-size: 1.2rem;
    position: relative;
    left: 1.5rem;
    top: -1.5rem;
}
.tags a {
    text-decoration: none;
}

    </style>
  </head>
  <body><div class='container'><div class='row'><a href='https://40ants.com/lisp-project-of-the-day/rss.xml' style='display: block; float: right;'><img alt='RSS Feed' src='https://40ants.com/lisp-project-of-the-day/media/images/rss.png' /></a><header><h1 style='text-align: center'><a href='../../index.html'>Lisp Project of the Day</a></h1><h2 style='text-align: center'>pzmq</h2></header><div class='col-md-12 col-md-offset-0'><center><h3>You can support this project by donating at:</h3><a href='https://www.patreon.com/bePatron?u=33868637'><img alt='Donate using Patreon' src='https://40ants.com/lisp-project-of-the-day/media/images/patreon-btn.png' width='160' /></a><a href='https://liberapay.com/poftheday/donate'><img alt='Donate using Liberapay' src='https://liberapay.com/assets/widgets/donate.svg' /></a><p>Or see <a href='https://40ants.com/lisp-project-of-the-day/patrons/index.html'>the list of project sponsors</a>.</p></center><h1>pzmq<span class='tags'><a href='../../tags/network.html'><span class='label label-default'>network</span></a><a href='../../tags/rpc.html'><span class='label label-default'>rpc</span></a><a href='../../tags/protocols.html'><span class='label label-default'>protocols</span></a></span></h1><table style='position: relative; float: right; background-color: #F1F1F1; padding: 1em; margin-left: 1em; margin-bottom: 1em; border: 1px solid #D1D1D1;'><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Documentation</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Docstrings</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ˜€</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Tests</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>   ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Examples</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ˜€</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>RepositoryActivity</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ˜€</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>CI</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>      ðŸ¥º</td></tr></table><p>ZeroMQ is a networking library. It is not a message broker and it will not run tasks for you. Instead, it provides simple primitives for different network patterns.</p>
<p>With ZeroMQ you can easily implement these patterns: Request-Response, Pub-Sub, Push-Pull.</p>
<p>I found 3 CL systems implementing bindings to ZeroMQ:</p>
<ul><li>pzmq - <a href="https://github.com/orivej/pzmq">https://github.com/orivej/pzmq</a> (ZeroMQ 4.0 bindings) active</li><li>zeromq <a href="https://github.com/freiksenet/cl-zmq">https://github.com/freiksenet/cl-zmq</a> ZeroMQ 3 (7 years ago)</li><li>zmq <a href="https://github.com/galdor/lisp-zmq">https://github.com/galdor/lisp-zmq</a> Up to ZeroMQ 3.2 (7 year ago)</li></ul>
<p>I know, names of the repositories, CL systems and packages are all different. That is the HELL :(</p>
<p>There is also at least two different versions of the <code>zmq</code>:</p>
<ul><li>First one is referred by <a href="https://www.cliki.net/cl-zmq">https://www.cliki.net/cl-zmq</a> and included   into Quicklisp. But examples from the ZeroMQ Guide not work with this   <code>zmq</code> because <code>msg-data-as-is</code> function is absent.</li><li>The second one is <a href="https://github.com/tsbattman/cl-zmq">https://github.com/tsbattman/cl-zmq</a> and seems it is   the version, used in ZeroMQ Guide. But it is not in the Quicklisp (yet   or anymore).</li></ul>
<p>Anyway, both of them are stale and didn't get updates 7-8 years. They are using the old 3.2 version of ZeroMQ. Today we'll talk about <code>pzmq</code>.</p>
<p>PZMQ has some activity in the repository and uses ZeroMQ 4. It does not have docs but it has <a href="https://github.com/orivej/pzmq/blob/master/examples.lisp">some examples</a>, ported from the <a href="https://zguide.zeromq.org/docs/chapter1/">ZeroMQ Guide</a>.</p>
<p>I slightly modified the examples code, to make the output more readable when client and server are running from one REPL.</p>
<p>This snippet shows the server's code. It listens on the 5555 port and blocks until a message received, then responds and waits for another message:</p>
<pre><code class='lisp'>POFTHEDAY&gt; (defun hwserver (&amp;optional (listen-address &quot;tcp://*:5555&quot;))
             (pzmq:with-context nil ; use *default-context*
               (pzmq:with-socket responder :rep
                 (pzmq:bind responder listen-address)
                 (loop
                   (write-line &quot;SERVER: Waiting for a request... &quot;)
                   (format t &quot;SERVER: Received ~A~%&quot;
                           (pzmq:recv-string responder))
                   (sleep 1)
                   (pzmq:send responder &quot;World&quot;)))))</code></pre><p>The client does the opposite - it sends some data and waits for the response. Depending on the pattern you use, you have to set socket types. For the server, we used :rep (reply) and for client we are using :req (request).</p>
<pre><code class='lisp'>POFTHEDAY&gt; (defun hwclient (&amp;optional (server-address &quot;tcp://localhost:5555&quot;))
             (pzmq:with-context (ctx :max-sockets 10)
               (pzmq:with-socket (requester ctx) (:req :affinity 3 :linger 100)
                 ;; linger is important in case of (keyboard) interrupt;
                 ;; see http://api.zeromq.org/3-3:zmq-ctx-destroy
                 (write-line &quot;CLIENT: Connecting to hello world server...&quot;)
                 (pzmq:connect requester server-address)
                 (dotimes (i 3)
                   (format t &quot;CLIENT: Sending Hello ~d...~%&quot; i)
                   (pzmq:send requester &quot;Hello&quot;)
                   (write-string &quot;CLIENT: Receiving... &quot;)
                   (write-line (pzmq:recv-string requester))))))</code></pre><p>Here is what we'll see when running the server in the background and starting the client in the REPL:</p>
<pre><code class='lisp'>POFTHEDAY&gt; (defparameter *server-thread*
             (bt:make-thread #&#039;hwserver))

SERVER: Waiting for a request... 

POFTHEDAY&gt; (hwclient)
CLIENT: Connecting to hello world server...
CLIENT: Sending Hello 0...
CLIENT: Receiving... Hello
SERVER: Waiting for a request... World
CLIENT: Sending Hello 1...
CLIENT: Receiving... Hello
SERVER: Waiting for a request... World
CLIENT: Sending Hello 2...
CLIENT: Receiving... Hello
SERVER: Waiting for a request... World
NIL</code></pre><p>What is next?</p>
<p>Read about Pub-Sub and Push-Pull patterns at <a href="https://zguide.zeromq.org/docs/chapter1/">the ZeroMQ Guide</a> and try to port them on <code>pzmq</code>.</p>
<p>Also, it would be cool to port <a href="https://github.com/booksbyus/zguide/tree/master/examples/CL">all Common Lisp examples</a> from the unsupported library to the <code>pzmq</code> and to send a pull-request.</p>
<p>By the way, there is at least one cool project, which already uses <code>pzmq</code> to connect parts written in Common Lisp and Python. It is recently reviewed <a href="https://40ants.com/lisp-project-of-the-day/2020/09/0197-common-lisp-jupyter.html">common-lisp-jupyter</a> library.</p>
<p>To conclude, this library definitely should be tried if you are going to implement a distributed application! Especially if it will interop with parts written in other languages than Common Lisp.</p>

<script src="https://utteranc.es/client.js"
        repo="40ants/lisp-project-of-the-day"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div></div><div><hr /><center><p>Brought to you by 40Ants under&nbsp;<a rel='license' href='http://creativecommons.org/licenses/by-sa/4.0/'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by-sa/4.0/88x31.png' /></a></p></center></div></div>
  </body>
</html>