<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <title>cl-vcr
    </title>
    <link rel='alternate' href='https://40ants.com/lisp-project-of-the-day/rss.xml' type='application/rss+xml' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL71WXK73K"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FL71WXK73K');
      </script>
  
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
         (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
         m[i].l=1*new Date();
         for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
         k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
         (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

         ym(42462884, "init", {
              clickmap:true,
              trackLinks:true,
              accurateTrackBounce:true
         });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/42462884" style="position:absolute ; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->

    <link type='text/css' rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' />
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    <link rel='stylesheet' href='../../highlight/styles/tomorrow-night.css' />
    <script src='../../highlight/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad() ;
    </script>
    <style>

.tags .label {
    margin-right: 1em;
}
.posts tr {
    line-height: 1.7em;
}
.posts tr td.number {
    font-weight: bold;
    padding-right: 0.7em;
}
.posts tr td.tags {
    padding-left: 0.7em;
}
h1 .tags {
    font-size: 1.2rem;
    position: relative;
    left: 1.5rem;
    top: -1.5rem;
}
.tags a {
    text-decoration: none;
}

    </style>
  </head>
  <body><div class='container'><div class='row'><a href='https://40ants.com/lisp-project-of-the-day/rss.xml' style='display: block; float: right;'><img alt='RSS Feed' src='https://40ants.com/lisp-project-of-the-day/media/images/rss.png' /></a><header><h1 style='text-align: center'><a href='../../index.html'>Lisp Project of the Day</a></h1><h2 style='text-align: center'>cl-vcr</h2></header><div class='col-md-12 col-md-offset-0'><center><h3>You can support this project by donating at:</h3><a href='https://www.patreon.com/bePatron?u=33868637'><img alt='Donate using Patreon' src='https://40ants.com/lisp-project-of-the-day/media/images/patreon-btn.png' width='160' /></a><a href='https://liberapay.com/poftheday/donate'><img alt='Donate using Liberapay' src='https://liberapay.com/assets/widgets/donate.svg' /></a><p>Or see <a href='https://40ants.com/lisp-project-of-the-day/patrons/index.html'>the list of project sponsors</a>.</p></center><h1>cl-vcr<span class='tags'><a href='../../tags/testing.html'><span class='label label-default'>testing</span></a></span></h1><table style='position: relative; float: right; background-color: #F1F1F1; padding: 1em; margin-left: 1em; margin-bottom: 1em; border: 1px solid #D1D1D1;'><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Documentation</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Docstrings</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Tests</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>   ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>Examples</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>RepositoryActivity</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>ðŸ¥º</td></tr><tr><td style='padding-left: 0.5rem; padding-right: 0.5rem'>CI</td><td style='padding-left: 0.5rem; padding-right: 0.5rem; border-left: 1px solid #DDD'>      ðŸ˜€</td></tr></table><p>This system provides a simple macro which will remember all HTTP requests. Results are stored to the disk and will be reused. This should be useful if you need to rerun your integration tests frequently.</p>
<p>The README is short and only say that <code>cl-vcr</code> was inspired by <a href="https://github.com/vcr/vcr">https://github.com/vcr/vcr</a></p>
<p>By the way, <code>cl-vcr</code> is not in Quicklisp. Here is the link to the repository:</p>
<p><a href="https://github.com/kidd/cl-vcr">https://github.com/kidd/cl-vcr</a></p>
<p>Let's try it!</p>
<pre><code class='lisp'>;; CL-VCR stores it&#039;s data in /tmp/vcr/, but does
;; not create it itself :(
POFTHEDAY&gt; (ensure-directories-exist &quot;/tmp/vcr/&quot;)


POFTHEDAY&gt; (time
            (cl-vcr:with-vcr &quot;the-tape&quot;
              (drakma:http-request &quot;https://httpbin.org/delay/10&quot;)))
Evaluation took:
  10.859 seconds of real time
  0.037955 seconds of total run time (0.025274 user, 0.012681 system)
  0.35% CPU
  12 lambdas converted
  23,975,316,800 processor cycles
  5 page faults
  1,176,304 bytes consed
  
#(123 10 32 32 34 97 114 103 115 34 58 32 123 125 44 32 10 32 32 34 100 97 116
  97 34 58 32 34 34 44 32 10 32 32 34 102 105 108 101 115 34 58 32 123 125 44
  32 10 32 32 34 102 111 114 109 34 58 32 123 125 44 32 10 32 32 34 104 101 97
  100 101 114 115 34 58 32 123 10 32 32 32 32 34 65 99 99 101 112 116 34 58 32
  34 42 47 42 34 44 32 10 32 32 32 32 34 72 111 115 116 34 58 32 34 104 116 116
  112 98 105 110 46 111 114 103 34 44 32 10 32 32 32 32 34 85 115 101 114 45 65
  103 101 110 116 34 58 32 34 68 114 97 107 109 97 47 50 46 48 46 55 32 40 83
  66 67 76 32 50 46 48 46 56 59 32 68 97 114 119 105 110 59 32 49 57 46 53 46
  48 59 32 104 116 116 112 58 47 47 119 101 105 116 122 46 100 101 47 100 114
  97 107 109 97 47 41 34 44 32 10 32 32 32 32 34 88 45 65 109 122 110 45 84 114
  97 99 101 45 73 100 34 58 32 34 82 111 111 116 61 49 45 53 102 53 54 56 98 57
  48 45 98 55 102 53 56 99 98 48 52 57 57 55 51 51 53 48 100 52 48 56 52 55 55
  48 34 10 32 32 125 44 32 10 32 32 34 111 114 105 103 105 110 34 58 32 34 51
  49 46 49 55 51 46 56 48 46 55 34 44 32 10 32 32 34 117 114 108 34 58 32 34
  104 116 116 112 115 58 47 47 104 116 116 112 98 105 110 46 111 114 103 47 100
  101 108 97 121 47 49 48 34 10 125 10)

POFTHEDAY&gt; (time
            (cl-vcr:with-vcr &quot;the-tape&quot;
              (drakma:http-request &quot;https://httpbin.org/delay/10&quot;)))
; Debugger entered on #&lt;SIMPLE-TYPE-ERROR expected-type: SB-IMPL::FUNCTION-NAME
;                     datum: (LAMBDA () :IN DRAKMA::MAKE-SSL-STREAM)&gt;</code></pre><p>As you can see, here we have two problems:</p>
<ul><li>cl-vcr does not work;</li><li>drakma is not able to decode httpbin.org's JSON response (honestly, I   tried different arguments to <code>http-request</code>.</li></ul>
<p>Fortunately, there is cool Dexador, which "just works" and a hack to make <code>cl-vcr</code> use it. But "ups!" it does not work either, because <code>cl-vcr</code> tries to remember all returned values, including SSL stream and associated CFFI structure of the networking socket:</p>
<pre><code class='lisp'>POFTHEDAY&gt; (time
            (let ((cl-vcr::*http-call* &#039;dex:request))
              (cl-vcr:with-vcr &quot;the-tape&quot;
                (dex:get &quot;https://httpbin.org/delay/10&quot;))))
; Debugger entered on #&lt;CL-STORE:STORE-ERROR {100C4C3E73}&gt;

;; This is what dex:get returns as it&#039;s values:
POFTHEDAY&gt; (dex:get &quot;https://httpbin.org/delay/10&quot;)
&quot;{
  \&quot;args\&quot;: {}, 
  \&quot;data\&quot;: \&quot;\&quot;, 
  \&quot;files\&quot;: {}, 
  \&quot;form\&quot;: {}, 
  \&quot;headers\&quot;: {
    \&quot;Accept\&quot;: \&quot;*/*\&quot;, 
    \&quot;Content-Length\&quot;: \&quot;0\&quot;, 
    \&quot;Host\&quot;: \&quot;httpbin.org\&quot;, 
    \&quot;User-Agent\&quot;: \&quot;Dexador/0.9.14 (SBCL 2.0.8); Darwin; 19.5.0\&quot;, 
    \&quot;X-Amzn-Trace-Id\&quot;: \&quot;Root=1-5f568fb6-f74ff20069c9dca0a0b0c760\&quot;
  }, 
  \&quot;origin\&quot;: \&quot;31.173.80.7\&quot;, 
  \&quot;url\&quot;: \&quot;https://httpbin.org/delay/10\&quot;
}
&quot;
200 (8 bits, #xC8, #o310, #b11001000)
#&lt;HASH-TABLE :TEST EQUAL :COUNT 7 {100C4BBC93}&gt;
#&lt;QURI.URI.HTTP:URI-HTTPS https://httpbin.org/delay/10&gt;
#&lt;CL+SSL::SSL-STREAM for #&lt;FD-STREAM for &quot;socket 192.168.43.216:64553, peer: 35.170.21.246:443&quot; {100C4AE583}&gt;&gt;</code></pre><p>We can overcome these difficulties by creating a wrapper to make HTTP requests and return only the result.</p>
<p>First call returns in 10 seconds:</p>
<pre><code class='lisp'>POFTHEDAY&gt; (defun http-get (url)
             (values (dex:get url)))

POFTHEDAY&gt; (time
            (let ((cl-vcr::*http-call* &#039;http-get))
              (cl-vcr:with-vcr &quot;the-tape&quot;
                (http-get &quot;https://httpbin.org/delay/10&quot;))))
Evaluation took:
  10.175 seconds of real time
  0.020157 seconds of total run time (0.013977 user, 0.006180 system)
  0.20% CPU
  52 lambdas converted
  22,465,739,006 processor cycles
  4,203,120 bytes consed
  
&quot;{
  \&quot;args\&quot;: {}, 
  \&quot;data\&quot;: \&quot;\&quot;, 
  \&quot;files\&quot;: {}, 
  \&quot;form\&quot;: {}, 
  \&quot;headers\&quot;: {
    \&quot;Accept\&quot;: \&quot;*/*\&quot;, 
    \&quot;Content-Length\&quot;: \&quot;0\&quot;, 
    \&quot;Host\&quot;: \&quot;httpbin.org\&quot;, 
    \&quot;User-Agent\&quot;: \&quot;Dexador/0.9.14 (SBCL 2.0.8); Darwin; 19.5.0\&quot;, 
    \&quot;X-Amzn-Trace-Id\&quot;: \&quot;Root=1-5f5692a6-fde6da521dce37dc2983bb9e\&quot;
  }, 
  \&quot;origin\&quot;: \&quot;31.173.80.7\&quot;, 
  \&quot;url\&quot;: \&quot;https://httpbin.org/delay/10\&quot;
}
&quot;</code></pre><p>But second call returns immediately:</p>
<pre><code class='lisp'>POFTHEDAY&gt; (time
            (let ((cl-vcr::*http-call* &#039;http-get))
              (cl-vcr:with-vcr &quot;the-tape&quot;
                (http-get &quot;https://httpbin.org/delay/10&quot;))))
Evaluation took:
  0.005 seconds of real time
  0.005484 seconds of total run time (0.004814 user, 0.000670 system)
  100.00% CPU
  26 lambdas converted
  12,198,056 processor cycles
  1,996,128 bytes consed
  
&quot;{
  \&quot;args\&quot;: {}, 
  \&quot;data\&quot;: \&quot;\&quot;, 
  \&quot;files\&quot;: {}, 
  \&quot;form\&quot;: {}, 
  \&quot;headers\&quot;: {
    \&quot;Accept\&quot;: \&quot;*/*\&quot;, 
    \&quot;Content-Length\&quot;: \&quot;0\&quot;, 
    \&quot;Host\&quot;: \&quot;httpbin.org\&quot;, 
    \&quot;User-Agent\&quot;: \&quot;Dexador/0.9.14 (SBCL 2.0.8); Darwin; 19.5.0\&quot;, 
    \&quot;X-Amzn-Trace-Id\&quot;: \&quot;Root=1-5f5692a6-fde6da521dce37dc2983bb9e\&quot;
  }, 
  \&quot;origin\&quot;: \&quot;31.173.80.7\&quot;, 
  \&quot;url\&quot;: \&quot;https://httpbin.org/delay/10\&quot;
}
&quot;</code></pre><p>There is another problem with <code>cl-vcr</code> - it does not use <code>unwind-protect</code> to run <code>unmemoize</code>. That is why it applied memoization patch to the <code>dex:request</code> function, but didn't roll it back on the error.</p>
<p>What could I say? <code>CL-VCR</code> is a good example of a really bad implementation of a nice idea :)</p>

<script src="https://utteranc.es/client.js"
        repo="40ants/lisp-project-of-the-day"
        issue-term="title"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div></div><div><hr /><center><p>Brought to you by 40Ants under&nbsp;<a rel='license' href='http://creativecommons.org/licenses/by-sa/4.0/'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by-sa/4.0/88x31.png' /></a></p></center></div></div>
  </body>
</html>